# Quick Start Guide: Subscription & Access Control\n\n## Import Middleware\n\n```typescript\nimport {\n  loadEnhancedSubscriptionInfo,\n  requireActiveSubscription,\n  requireFeature,\n  requireMinimumTier,\n  requireOrgRole,\n  requireModuleAccess,\n  requireResidentCapacity,\n  requirePropertyCapacity,\n  enforceMultiTenancy,\n} from '../middleware/subscriptionAndTenancyMiddleware';\n\nimport {\n  SUBSCRIPTION_TIERS,\n  MODULE_ACCESS,\n  tierHasFeature,\n  canAccessModule,\n} from '../constants/subscriptionTiers';\n```\n\n## Global Setup\n\n```typescript\n// In server/index.ts, after authentication middleware\napp.use(requireAuth());                    // Supabase Auth\napp.use(loadEnhancedSubscriptionInfo);     // Load subscription data\n```\n\n## Route Protection Examples\n\n### 1. Basic Route (Any Subscriber)\n\n```typescript\napp.get('/api/dashboard',\n  requireActiveSubscription,\n  enforceMultiTenancy,\n  dashboardHandler\n);\n```\n\n### 2. Tier-Locked Route\n\n```typescript\napp.get('/api/analytics',\n  requireModuleAccess('analytics'),  // Only professional+\n  enforceMultiTenancy,\n  analyticsHandler\n);\n\n// Alternative: explicit tier requirement\napp.get('/api/ai-insights',\n  requireMinimumTier('enterprise'),\n  enforceMultiTenancy,\n  aiHandler\n);\n```\n\n### 3. Feature-Locked Route\n\n```typescript\napp.get('/api/crisis-tools',\n  requireFeature('crisisConnect'),\n  enforceMultiTenancy,\n  crisisHandler\n);\n```\n\n### 4. Admin-Only Route\n\n```typescript\napp.post('/api/organization/settings',\n  requireOrgRole('admin'),\n  enforceMultiTenancy,\n  updateSettingsHandler\n);\n\n// Multiple roles\napp.delete('/api/members/:id',\n  requireOrgRole(['admin', 'manager']),\n  enforceMultiTenancy,\n  deleteMemberHandler\n);\n```\n\n### 5. Capacity-Limited Routes\n\n```typescript\napp.post('/api/residents',\n  requireActiveSubscription,\n  requireResidentCapacity,\n  enforceMultiTenancy,\n  createResidentHandler\n);\n\napp.post('/api/properties',\n  requireActiveSubscription,\n  requirePropertyCapacity,\n  enforceMultiTenancy,\n  createPropertyHandler\n);\n```\n\n### 6. Combined Requirements\n\n```typescript\n// Example: Advanced reporting (professional+ tier, admin or manager role)\napp.get('/api/advanced-reports',\n  requireModuleAccess('reports'),\n  requireOrgRole(['admin', 'manager']),\n  enforceMultiTenancy,\n  advancedReportsHandler\n);\n```\n\n## Accessing Subscription Info in Handlers\n\n```typescript\napp.get('/api/example', async (req, res) => {\n  // Type-safe access\n  const { subscription } = req;\n  \n  if (!subscription) {\n    return res.status(401).json({ error: 'Not authenticated' });\n  }\n\n  // Organization & Subscription\n  const {\n    organizationId,\n    organizationName,\n    subscriptionTier,\n    subscriptionStatus,\n  } = subscription;\n\n  // Resource Usage\n  const {\n    currentResidentCount,\n    maxResidents,\n    residentUsagePercent,\n    currentPropertyCount,\n    maxProperties,\n    propertyUsagePercent,\n  } = subscription;\n\n  // Features & Capabilities\n  const { features } = subscription;\n  const hasAnalytics = features['advancedAnalytics'];\n  const hasCrisisConnect = features['crisisConnect'];\n\n  // User Info\n  const { userRole, isOrgAdmin, isPrimaryOrganization } = subscription;\n\n  // Billing\n  const { billingCycle, nextBillingDate, stripeCustomerId } = subscription;\n\n  // Alerts\n  const { hasResidentUsageAlert, hasPropertyUsageAlert } = subscription;\n\n  // Use the info\n  console.log(`Organization: ${organizationName}`);\n  console.log(`Tier: ${subscriptionTier}`);\n  console.log(`Resident Usage: ${residentUsagePercent.toFixed(1)}%`);\n\n  res.json({\n    organization: organizationName,\n    tier: subscriptionTier,\n    residentCount: currentResidentCount,\n    maxAllowed: maxResidents,\n  });\n});\n```\n\n## Using Constants\n\n```typescript\nimport {\n  SUBSCRIPTION_TIERS,\n  MODULE_ACCESS,\n  USER_ROLES,\n  tierHasFeature,\n} from '../constants/subscriptionTiers';\n\n// Get tier configuration\nconst starterConfig = SUBSCRIPTION_TIERS.starter;\nconsole.log(starterConfig.monthlyPrice);  // 199\nconsole.log(starterConfig.limits.maxResidents);  // 25\n\n// Check feature availability\nconst hasCrisis = tierHasFeature('professional', 'crisisConnect');  // true\nconst hasAI = tierHasFeature('starter', 'aiPoweredInsights');  // false\n\n// Module access matrix\nconst canAccessAnalytics = MODULE_ACCESS.analytics.professional;  // true\nconst canAccessReports = MODULE_ACCESS.reports.starter;  // false\n\n// Get available features for tier\nconst tierConfig = SUBSCRIPTION_TIERS.professional;\nconst availableFeatures = Object.entries(tierConfig.features)\n  .filter(([_, enabled]) => enabled)\n  .map(([feature, _]) => feature);\n```\n\n## Error Responses\n\n### No Subscription\n```json\n{\n  \"error\": \"NO_SUBSCRIPTION\",\n  \"message\": \"No active subscription found. Please subscribe to continue.\"\n}\n```\n\n### Subscription Inactive\n```json\n{\n  \"error\": \"SUBSCRIPTION_INACTIVE\",\n  \"message\": \"Payment is overdue. Please update your payment method to continue.\",\n  \"subscriptionStatus\": \"past_due\",\n  \"subscriptionTier\": \"professional\",\n  \"requiredAction\": \"renew_subscription\"\n}\n```\n\n### Feature Not Available\n```json\n{\n  \"error\": \"FEATURE_NOT_AVAILABLE\",\n  \"message\": \"This feature is not available in your starter plan.\",\n  \"featureName\": \"crisisConnect\",\n  \"currentTier\": \"starter\",\n  \"requiredUpgrade\": true,\n  \"upgradeSuggestion\": \"professional\"\n}\n```\n\n### Tier Too Low\n```json\n{\n  \"error\": \"INSUFFICIENT_TIER\",\n  \"message\": \"This feature requires enterprise plan or higher.\",\n  \"currentTier\": \"professional\",\n  \"requiredTier\": \"enterprise\",\n  \"requiredUpgrade\": true\n}\n```\n\n### Resident Limit Reached\n```json\n{\n  \"error\": \"RESIDENT_LIMIT_REACHED\",\n  \"message\": \"You have reached your resident limit (25).\",\n  \"currentCount\": 25,\n  \"maxAllowed\": 25,\n  \"requiredUpgrade\": true\n}\n```\n\n### Insufficient Role\n```json\n{\n  \"error\": \"INSUFFICIENT_ROLE\",\n  \"message\": \"This action requires one of these roles: admin, manager\",\n  \"currentRole\": \"staff\",\n  \"requiredRoles\": [\"admin\", \"manager\"]\n}\n```\n\n### Organization Mismatch\n```json\n{\n  \"error\": \"ORGANIZATION_MISMATCH\",\n  \"message\": \"You do not have access to this organization.\",\n  \"requestedOrganization\": 123,\n  \"allowedOrganization\": 456\n}\n```\n\n## Common Patterns\n\n### Pattern 1: Premium Feature\nBlocks access unless user has higher tier OR specific feature enabled:\n\n```typescript\napp.get('/api/ai-insights',\n  requireMinimumTier('professional'),\n  enforceMultiTenancy,\n  async (req, res) => { /* ... */ }\n);\n```\n\n### Pattern 2: Admin Function\nRequires admin role in organization:\n\n```typescript\napp.post('/api/organization/update',\n  requireOrgRole('admin'),\n  enforceMultiTenancy,\n  async (req, res) => { /* ... */ }\n);\n```\n\n### Pattern 3: Capacity Check\nPrevents exceeding usage limits:\n\n```typescript\napp.post('/api/residents',\n  requireResidentCapacity,\n  enforceMultiTenancy,\n  async (req, res) => { /* ... */ }\n);\n```\n\n### Pattern 4: Feature Specific\nRequires feature flag to be enabled:\n\n```typescript\napp.get('/api/crisis-dashboard',\n  requireFeature('crisisConnect'),\n  enforceMultiTenancy,\n  async (req, res) => { /* ... */ }\n);\n```\n\n### Pattern 5: Multi-Role Access\nAllows multiple roles:\n\n```typescript\napp.delete('/api/staff/:id',\n  requireOrgRole(['admin', 'manager']),\n  enforceMultiTenancy,\n  async (req, res) => { /* ... */ }\n);\n```\n\n## Testing Subscription Access\n\n### Test Endpoint (Development)\n\n```typescript\n// Add to routes for debugging\napp.get('/api/debug/subscription', (req, res) => {\n  res.json({\n    user: req.user?.id,\n    subscription: req.subscription,\n    tenant: req.tenant,\n  });\n});\n```\n\n### Using in Tests\n\n```typescript\nimport request from 'supertest';\n\ndescribe('Subscription Access Control', () => {\n  it('should block non-subscribers', async () => {\n    const res = await request(app)\n      .get('/api/analytics')\n      .set('Authorization', `Bearer ${token}`);\n\n    expect(res.status).toBe(403);\n    expect(res.body.error).toBe('SUBSCRIPTION_INACTIVE');\n  });\n\n  it('should allow professional subscribers', async () => {\n    const res = await request(app)\n      .get('/api/analytics')\n      .set('Authorization', `Bearer ${professionalToken}`);\n\n    expect(res.status).toBe(200);\n  });\n\n  it('should check resident capacity', async () => {\n    const res = await request(app)\n      .post('/api/residents')\n      .set('Authorization', `Bearer ${token}`)\n      .send({ /* ... */ });\n\n    expect(res.status).toBe(403);\n    expect(res.body.error).toBe('RESIDENT_LIMIT_REACHED');\n  });\n});\n```\n\n## Migration Guide (For Existing Routes)\n\n### Before\n```typescript\napp.get('/api/dashboard', async (req, res) => {\n  // Manual subscription check\n  const org = await db.query.organizations.findFirst({\n    where: eq(organizations.id, req.organizationId),\n  });\n  \n  if (!org?.subscriptionStatus === 'active') {\n    return res.status(403).json({ error: 'Inactive subscription' });\n  }\n  \n  // ... rest of handler\n});\n```\n\n### After\n```typescript\napp.get('/api/dashboard',\n  requireActiveSubscription,\n  enforceMultiTenancy,\n  async (req, res) => {\n    const { organizationId } = req.subscription;\n    // ... rest of handler (subscription check already done)\n  }\n);\n```\n\n## Checklist for Route Protection\n\n- [ ] Import necessary middleware\n- [ ] Add `requireActiveSubscription` if subscription required\n- [ ] Add `requireModuleAccess('module')` if tier-gated\n- [ ] Add `requireFeature('feature')` for specific features\n- [ ] Add `requireMinimumTier('tier')` for tier requirements\n- [ ] Add `requireOrgRole('role')` for admin/manager functions\n- [ ] Add `requireResidentCapacity` or `requirePropertyCapacity` if creates resources\n- [ ] Add `enforceMultiTenancy` to all protected routes\n- [ ] Test with subscription info logged\n- [ ] Verify error messages are descriptive\n- [ ] Update frontend to handle 403 responses with upgrade prompts\n\n## Performance Notes\n\n- `loadEnhancedSubscriptionInfo` runs once per request (cached in middleware)\n- No N+1 queries - single JOIN query loads all needed data\n- Middleware stack short-circuits on first failure\n- Tier hierarchy lookups are O(1) with constant map\n- Module access checks are O(1) with constant matrix\n"