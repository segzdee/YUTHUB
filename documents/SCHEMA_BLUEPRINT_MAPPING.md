# YUTHUB Database Schema Blueprint Mapping\n\n## Document Purpose\n\nThis document maps your existing Drizzle ORM schema (`shared/schema.ts`) to the comprehensive multi-tenant SaaS database blueprint provided. It identifies:\n- Which tables are already implemented\n- Which tables need to be added\n- Which existing tables need enhancement for full multi-tenancy\n- SQL RLS (Row-Level Security) policies needed for data isolation\n\n---\n\n## Schema Status Overview\n\n‚úÖ = Implemented  \nüîÑ = Needs Enhancement  \n‚ùå = Missing / Needs to be Added  \n\n---\n\n## 1. Core SaaS Infrastructure (Multi-Tenant + Billing)\n\n### 1.1 Tenant Management\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `organizations` | ‚úÖ | Fully implemented with subscription fields | None - Add RLS policy |\n| `userOrganizations` | ‚úÖ | Junction table for user-org membership | None - Add RLS policy |\n| `subscriptionPlans` | ‚úÖ | Defines available tiers (starter, professional, enterprise) | Verify features JSON structure |\n| `users` | ‚úÖ | Auth users with subscription metadata | üîÑ Add `organizationId` FK for primary org context |\n\n### 1.2 Access Control\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `rolesPermissions` | ‚úÖ | RBAC with system roles | Ensure complete permission matrix |\n| `authAuditLog` | ‚úÖ | Tracks auth events | None |\n| `apiTokens` | ‚úÖ | API key management | Add `organizationId` FK |\n| `permissionCache` | ‚úÖ | Performance optimization | None |\n\n### 1.3 Billing & Payments\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `governmentClients` | ‚úÖ | Customer reference data | None |\n| `supportLevelRates` | ‚úÖ | Service tier pricing | None |\n| `billingPeriods` | ‚úÖ | Occupancy-based billing | None |\n| `invoices` | ‚úÖ | Invoice generation | None |\n| `invoiceLineItems` | ‚úÖ | Line-item detail | None |\n| `paymentReminders` | ‚úÖ | Automated reminders | None |\n| `auditTrail` | ‚úÖ | Audit logging | None |\n\n### 1.4 Security & Compliance\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `auditLogs` | ‚úÖ | General audit trail | üîÑ Add `organizationId` for multi-tenant filtering |\n| `accountLockouts` | ‚úÖ | Account security | None |\n| `authAuditLog` | ‚úÖ | Auth-specific logging | None |\n\n---\n\n## 2. Housing Management\n\n### 2.1 Core Housing Entities\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `properties` | ‚úÖ | Property/building records | ‚úÖ Already has `organizationId` |\n| `propertyRooms` | ‚úÖ | Individual rooms/units | üîÑ Add `organizationId` FK |\n| `residents` | ‚úÖ | Resident profiles | ‚úÖ Already has `organizationId` |\n| `units` | ‚ùå | NOT FOUND | üéØ Create as `propertyRooms` (already done) |\n\n### 2.2 Occupancy & Placement\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `tenancyAgreements` | ‚úÖ | Tenancy records | üîÑ Add `organizationId` FK |\n| `placements` | ‚ùå | NOT FOUND | üéØ Create from `residents` move-in/move-out dates |\n| `moveRecords` | ‚úÖ | Move history | üîÑ Add `organizationId` FK |\n| `occupancySnapshots` | ‚ùå | NOT FOUND | üéØ Create as materialized view or scheduled job |\n\n### 2.3 Files & Documents\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `documentStorage` | ‚úÖ | File management | ‚úÖ Already has `organizationId` context via entityType/entityId |\n| `fileSharing` | ‚úÖ | Secure sharing | None |\n| `fileAccessLogs` | ‚úÖ | Access audit | None |\n| `fileBackupRecords` | ‚úÖ | Backup tracking | üîÑ Add `organizationId` FK |\n\n---\n\n## 3. Support Services (Plans, Goals, Outcomes)\n\n### 3.1 Support Planning\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `supportPlans` | ‚úÖ | Support plans per resident | ‚úÖ Already has `organizationId` |\n| `goals` | ‚ùå | NOT FOUND | üéØ Likely part of `progressTracking` |\n| `progressTracking` | ‚úÖ | Goal progress | üîÑ Add `organizationId` FK |\n| `interventions` / `sessions` | ‚ùå | NOT FOUND | üéØ Consider adding as `progressTracking` events |\n| `outcomes` | ‚úÖ | `outcomesTracking` table exists | ‚úÖ Already has `organizationId` |\n| `caseNotes` | ‚ùå | NOT FOUND | üéØ Consider adding for narrative documentation |\n\n---\n\n## 4. Safeguarding (Incident ‚Üí Risk ‚Üí Referral ‚Üí Actions)\n\n### 4.1 Incident Management\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `incidents` | ‚úÖ | Safeguarding events | ‚úÖ Already has `organizationId` |\n| `riskAssessments` | ‚úÖ | Risk evaluation | ‚úÖ Already has `organizationId` |\n| `referrals` | ‚úÖ | External escalations | ‚úÖ Already has `organizationId` |\n| `agencies` | ‚ùå | NOT FOUND | üéØ Create agencies directory |\n\n### 4.2 Actions & Follow-up\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `actions` / `actionAssignments` | ‚ùå | NOT FOUND | üéØ Create action tracking system |\n\n### 4.3 Emergency Response\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `crisisTeams` | ‚úÖ | Crisis response teams | üîÑ Add `organizationId` FK |\n| `emergencyContacts` | ‚úÖ | Emergency contact directory | ‚úÖ Already has `organizationId` context |\n\n---\n\n## 5. Financial Management\n\n### 5.1 Resident Accounts\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `rentPayments` | ‚úÖ | Payment tracking | ‚úÖ Already has `organizationId` context |\n| `financialRecords` | ‚úÖ | General financial entries | ‚úÖ Already has `organizationId` |\n| `charges` | ‚úÖ | Included in `financialRecords` | None |\n\n### 5.2 Cost Centers & Budgets\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `costCenters` | ‚ùå | NOT FOUND | üéØ Create for budgeting |\n| `budgets` | ‚ùå | NOT FOUND | üéØ Create for budget tracking |\n\n---\n\n## 6. Independence Pathways\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `skills` | ‚ùå | NOT FOUND | üéØ Create skills catalog |\n| `skillAssessments` | ‚ùå | NOT FOUND | üéØ Create skills tracking |\n| `pathwayMilestones` | ‚ùå | NOT FOUND | üéØ Create milestone definitions |\n| `progressEvents` | ‚úÖ | `progressTracking` covers this | None |\n| `rewards` | ‚ùå | NOT FOUND | üéØ Create gamification rewards |\n\n---\n\n## 7. Operations & Maintenance\n\n### 7.1 Maintenance Management\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `maintenanceRequests` | ‚úÖ | Maintenance tickets | üîÑ Add `organizationId` FK |\n| `contractors` | ‚úÖ | Contractor management | üîÑ Add `organizationId` FK |\n| `inspections` | ‚úÖ | Property inspections | ‚úÖ Already has `organizationId` context |\n\n### 7.2 Property Management\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `assets` | ‚úÖ | Equipment tracking | üîÑ Add `organizationId` FK |\n| `utilities` | ‚úÖ | Utility management | üîÑ Add `organizationId` FK |\n| `insuranceRecords` | ‚úÖ | Insurance policies | ‚úÖ Already has `organizationId` |\n\n---\n\n## 8. Analytics & Reporting\n\n### 8.1 Real-time & Historical\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `activities` | ‚úÖ | Activity stream | ‚úÖ Already has `organizationId` |\n| `eventStream` | ‚ùå | NOT FOUND | Consider using `activities` |\n| `kpiSnapshots` | ‚ùå | NOT FOUND | üéØ Create for KPI tracking |\n\n### 8.2 Reporting\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `reportTemplates` | ‚úÖ | Custom report templates | ‚úÖ Already has `organizationId` |\n| `dashboardWidgets` | ‚úÖ | Dashboard customization | üîÑ Add `organizationId` FK |\n\n---\n\n## 9. Communication & Collaboration\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `communicationLogs` | ‚úÖ | Message & call logs | ‚úÖ Already has `organizationId` context |\n| `notifications` | ‚úÖ | In-app notifications | üîÑ Add `organizationId` FK |\n| `calendarEvents` | ‚úÖ | Appointments & reviews | ‚úÖ Already has `organizationId` context |\n| `communicationTemplates` | ‚úÖ | Message templates | ‚úÖ Already has `organizationId` |\n\n---\n\n## 10. Admin & Configuration\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `systemConfigurations` | ‚úÖ | Platform settings | üîÑ Add `organizationId` for org-level configs |\n| `formTemplates` | ‚ùå | NOT FOUND | üéØ Create form builder schema |\n| `lookupValues` | ‚ùå | NOT FOUND | üéØ Create controlled vocabularies |\n\n---\n\n## 11. Compliance & Feedback\n\n| Table | Status | Current State | Action Required |\n|-------|--------|---------------|------------------|\n| `consents` | ‚ùå | NOT FOUND | üéØ Create consent tracking |\n| `redactions` | ‚ùå | NOT FOUND | üéØ Create PII redaction system |\n| `complaints` | ‚úÖ | Complaint handling | üîÑ Add `organizationId` FK |\n| `surveys` | ‚úÖ | Survey management | ‚úÖ Already has `organizationId` |\n| `surveyResponses` | ‚úÖ | Survey responses | üîÑ Add `organizationId` FK for context |\n| `trainingRecords` | ‚úÖ | Staff training | ‚úÖ Already has `organizationId` context |\n\n---\n\n## Priority Enhancement Plan\n\n### Phase 1: Critical (Multi-Tenancy & RLS)\n**Deadline: ASAP**\n\n1. Add `organizationId` FK to tables missing it:\n   - `propertyRooms`\n   - `tenancyAgreements`\n   - `moveRecords`\n   - `fileBackupRecords`\n   - `progressTracking`\n   - `maintenanceRequests`\n   - `contractors`\n   - `assets`\n   - `utilities`\n   - `crisisTeams`\n   - `dashboardWidgets`\n   - `notifications`\n   - `systemConfigurations`\n   - `complaints`\n   - `surveyResponses`\n\n2. Implement RLS policies on ALL tables:\n   ```sql\n   -- Example pattern for every table\n   CREATE POLICY \"org_isolation_select\" ON table_name\n     FOR SELECT USING (\n       organization_id IN (\n         SELECT organization_id FROM user_organizations\n         WHERE user_id = auth.uid() AND is_active = true\n       )\n     );\n   \n   CREATE POLICY \"org_isolation_insert\" ON table_name\n     FOR INSERT WITH CHECK (\n       organization_id IN (\n         SELECT organization_id FROM user_organizations\n         WHERE user_id = auth.uid() AND is_active = true\n       )\n     );\n   ```\n\n### Phase 2: Important (Missing Core Tables)\n**Deadline: Sprint 2**\n\n1. `agencies` - External service providers\n2. `actionAssignments` - Safeguarding action tracking\n3. `caseNotes` - Narrative documentation\n4. `costCenters` - Budgeting\n5. `budgets` - Budget management\n6. `placements` - Placement history (separate from `moveRecords`)\n7. `occupancySnapshots` - Historical occupancy data\n\n### Phase 3: Enhancement (Nice-to-have)\n**Deadline: Sprint 3+**\n\n1. `skills` - Skills catalog\n2. `skillAssessments` - Skills tracking\n3. `pathwayMilestones` - Independence milestones\n4. `rewards` - Gamification rewards\n5. `kpiSnapshots` - KPI tracking\n6. `consents` - GDPR consent management\n7. `redactions` - Data redaction for PII\n8. `formTemplates` - Dynamic form builder\n9. `lookupValues` - Controlled vocabularies\n\n---\n\n## SQL Scripts\n\n### Add Missing `organizationId` Columns\n\n```sql\n-- propertyRooms\nALTER TABLE property_rooms ADD COLUMN organization_id INTEGER NOT NULL DEFAULT 1\n  REFERENCES organizations(id);\nCREATE INDEX idx_property_rooms_organization_id ON property_rooms(organization_id);\n\n-- tenancyAgreements\nALTER TABLE tenancy_agreements ADD COLUMN organization_id INTEGER NOT NULL DEFAULT 1\n  REFERENCES organizations(id);\nCREATE INDEX idx_tenancy_agreements_organization_id ON tenancy_agreements(organization_id);\n\n-- moveRecords\nALTER TABLE move_records ADD COLUMN organization_id INTEGER NOT NULL DEFAULT 1\n  REFERENCES organizations(id);\nCREATE INDEX idx_move_records_organization_id ON move_records(organization_id);\n\n-- ... (repeat for all tables listed above)\n```\n\n### Create Missing Core Tables\n\n#### Agencies\n```sql\nCREATE TABLE agencies (\n  id SERIAL PRIMARY KEY,\n  organization_id INTEGER NOT NULL REFERENCES organizations(id),\n  name VARCHAR(255) NOT NULL,\n  agency_type VARCHAR(50) NOT NULL, -- 'local_authority', 'police', 'health', 'education'\n  contact_name VARCHAR(255),\n  contact_email VARCHAR(255),\n  contact_phone VARCHAR(20),\n  address TEXT,\n  external_ids JSONB, -- Integration reference IDs\n  is_active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now(),\n  CONSTRAINT agencies_unique_org_name UNIQUE(organization_id, name)\n);\nCREATE INDEX idx_agencies_organization_id ON agencies(organization_id);\nCREATE INDEX idx_agencies_agency_type ON agencies(agency_type);\n```\n\n#### Action Assignments\n```sql\nCREATE TABLE action_assignments (\n  id SERIAL PRIMARY KEY,\n  organization_id INTEGER NOT NULL REFERENCES organizations(id),\n  incident_id INTEGER REFERENCES incidents(id),\n  risk_assessment_id INTEGER REFERENCES risk_assessments(id),\n  title VARCHAR(255) NOT NULL,\n  description TEXT,\n  assigned_to VARCHAR(255) NOT NULL REFERENCES users(id),\n  due_date DATE NOT NULL,\n  status VARCHAR(50) DEFAULT 'open', -- 'open', 'in_progress', 'completed', 'overdue', 'cancelled'\n  priority VARCHAR(50) DEFAULT 'medium', -- 'low', 'medium', 'high', 'urgent'\n  completion_notes TEXT,\n  completed_date TIMESTAMP,\n  evidence_files JSONB, -- File references\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\nCREATE INDEX idx_action_assignments_organization_id ON action_assignments(organization_id);\nCREATE INDEX idx_action_assignments_assigned_to ON action_assignments(assigned_to);\nCREATE INDEX idx_action_assignments_status ON action_assignments(status);\nCREATE INDEX idx_action_assignments_due_date ON action_assignments(due_date);\n```\n\n#### Case Notes\n```sql\nCREATE TABLE case_notes (\n  id SERIAL PRIMARY KEY,\n  organization_id INTEGER NOT NULL REFERENCES organizations(id),\n  resident_id INTEGER NOT NULL REFERENCES residents(id),\n  author_user_id VARCHAR(255) NOT NULL REFERENCES users(id),\n  visibility_scope VARCHAR(50) NOT NULL DEFAULT 'team', -- 'private', 'team', 'all'\n  content TEXT NOT NULL,\n  note_type VARCHAR(50), -- 'progress', 'incident', 'concern', 'positive', 'general'\n  is_confidential BOOLEAN DEFAULT false,\n  is_redacted BOOLEAN DEFAULT false,\n  redacted_by VARCHAR(255) REFERENCES users(id),\n  redaction_reason TEXT,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\nCREATE INDEX idx_case_notes_organization_id ON case_notes(organization_id);\nCREATE INDEX idx_case_notes_resident_id ON case_notes(resident_id);\nCREATE INDEX idx_case_notes_author_user_id ON case_notes(author_user_id);\nCREATE INDEX idx_case_notes_visibility_scope ON case_notes(visibility_scope);\nCREATE INDEX idx_case_notes_created_at ON case_notes(created_at);\n```\n\n---\n\n## RLS Policy Implementation\n\nAll tables should follow this pattern for multi-tenant isolation:\n\n```typescript\n// In RLS middleware or database setup\n\nconst rlsPolicies = `\n  -- Enable RLS on all tables\n  ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;\n  ALTER TABLE residents ENABLE ROW LEVEL SECURITY;\n  ALTER TABLE properties ENABLE ROW LEVEL SECURITY;\n  -- ... (all tables)\n  \n  -- Policy template for all tables\n  CREATE POLICY \"select_own_org\" ON residents\n    FOR SELECT\n    USING (\n      organization_id IN (\n        SELECT organization_id FROM user_organizations\n        WHERE user_id = auth.uid() \n          AND is_active = true\n          AND status = 'active'\n      )\n    );\n  \n  CREATE POLICY \"insert_own_org\" ON residents\n    FOR INSERT\n    WITH CHECK (\n      organization_id IN (\n        SELECT organization_id FROM user_organizations\n        WHERE user_id = auth.uid() \n          AND is_active = true\n          AND role IN ('admin', 'manager')\n      )\n    );\n  \n  CREATE POLICY \"update_own_org\" ON residents\n    FOR UPDATE\n    USING (\n      organization_id IN (\n        SELECT organization_id FROM user_organizations\n        WHERE user_id = auth.uid() \n          AND is_active = true\n          AND role IN ('admin', 'manager')\n      )\n    );\n  \n  CREATE POLICY \"delete_own_org\" ON residents\n    FOR DELETE\n    USING (\n      organization_id IN (\n        SELECT organization_id FROM user_organizations\n        WHERE user_id = auth.uid() \n          AND is_active = true\n          AND role = 'admin'\n      )\n    );\n`;\n```\n\n---\n\n## Verification Checklist\n\n- [ ] All tables have `organization_id` FK\n- [ ] All `organization_id` columns are indexed\n- [ ] All tables have RLS policies defined\n- [ ] RLS policies tested for isolation\n- [ ] Foreign key constraints include `ON DELETE CASCADE` where appropriate\n- [ ] Audit tables track organization context\n- [ ] Subscription tier feature flags properly enforced\n- [ ] API endpoints filter by `organizationId` from JWT token\n- [ ] Dashboard queries scoped to user's organizations\n- [ ] Reporting queries include organization segmentation\n\n---\n\n## References\n\n- Current Schema: `/shared/schema.ts`\n- SaaS Blueprint: User-provided comprehensive blueprint\n- Multi-Tenancy: Requires RLS policies + organization ID filtering\n- JWT Enhanced Context: `/server/services/enhancedJwtService.ts`\n"