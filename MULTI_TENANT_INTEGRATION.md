# Multi-Tenant Architecture Integration Guide\n\nThis document outlines the complete multi-tenant authentication, database, and frontend-backend integration for YUTHUB.\n\n## Architecture Overview\n\n```\n┌─────────────────────────────────────────────────────┐\n│              Frontend (React + TypeScript)          │\n│  ┌──────────────────────────────────────────────┐   │\n│  │ Protected Routes (Role-Based Access Control) │   │\n│  │ Auth Hooks (useAuth, useHasRole)            │   │\n│  │ API Client (Token Refresh, Org Context)     │   │\n│  │ Components (SignIn, Dashboard, etc)         │   │\n│  └──────────────────────────────────────────────┘   │\n└─────────────────────┬───────────────────────────────┘\n                      │ HTTP/REST\n                      │\n┌─────────────────────┴───────────────────────────────┐\n│           Backend (Express + TypeScript)           │\n│  ┌──────────────────────────────────────────────┐   │\n│  │ Multi-Auth Manager (Email, OAuth, LDAP)     │   │\n│  │ JWT Service (Token Generation & Validation)  │   │\n│  │ Enhanced Auth Middleware (Organization ID)   │   │\n│  │ RBAC Middleware (Role-Based Permissions)     │   │\n│  │ Tenant Context Middleware                    │   │\n│  └──────────────────────────────────────────────┘   │\n└─────────────────────┬───────────────────────────────┘\n                      │ SQL\n                      │\n┌─────────────────────┴───────────────────────────────┐\n│    Database (PostgreSQL + Drizzle ORM)             │\n│  ┌──────────────────────────────────────────────┐   │\n│  │ users (user credentials & subscriptions)     │   │\n│  │ organizations (tenant/account data)          │   │\n│  │ user_organizations (membership & roles)      │   │\n│  │ properties, residents, incidents, etc        │   │\n│  │ (all scoped by organization_id)              │   │\n│  └──────────────────────────────────────────────┘   │\n└──────────────────────────────────────────────────────┘\n```\n\n## Database Schema (Multi-Tenant)\n\n### Core Tables\n\n#### `organizations` (Tenants)\n```sql\n- id: PRIMARY KEY\n- name: Organization name\n- organizationType: 'housing_provider', 'local_authority', etc\n- subscriptionTier: 'trial', 'starter', 'professional', 'enterprise'\n- subscriptionStatus: 'trial', 'active', 'past_due', 'cancelled'\n- maxResidents: Resident limit per tier\n- maxProperties: Property limit per tier\n- stripeCustomerId: Stripe integration\n- featuresEnabled: JSON with feature flags\n```\n\n#### `users` (Cross-Tenant Users)\n```sql\n- id: User identifier\n- email: Unique email\n- role: 'staff', 'manager', 'admin', 'platform_admin'\n- subscriptionTier: User-level subscription (legacy)\n- passwordHash: For email/password auth\n- mfaEnabled: Multi-factor authentication\n```\n\n#### `user_organizations` (Membership Junction)\n```sql\n- userId: Foreign key to users\n- organizationId: Foreign key to organizations\n- role: Organization-specific role ('admin', 'manager', 'staff')\n- isPrimary: User's default/primary organization\n- status: 'active', 'inactive', 'invited', 'pending'\n- joinedDate: When user joined this organization\n```\n\n#### `properties`, `residents`, `incidents`, etc\n```sql\n- All data tables have:\n  - organizationId: Foreign key (REQUIRED)\n  - Index on (organizationId, status) for fast queries\n  - Scope all queries by organization_id\n```\n\n## Authentication Flow\n\n### 1. Login/Signup\n\n```typescript\n// Frontend: client/src/pages/SignIn.tsx\nconst handleLogin = async (email, password) => {\n  const response = await apiClient.post('/auth/login', {\n    email,\n    password,\n  });\n  // Response includes: { user, accessToken, refreshToken }\n  // Tokens stored in localStorage/sessionStorage\n};\n```\n\n### 2. Backend Authentication\n\n```typescript\n// Backend: server/routes.ts\napp.post('/auth/login', async (req, res) => {\n  const { email, password } = req.body;\n  \n  // 1. Verify credentials\n  const user = await db.query(users).where(eq(users.email, email));\n  \n  // 2. Get user's organizations\n  const orgs = await db.query(userOrganizations)\n    .where(eq(userOrganizations.userId, user.id));\n  \n  // 3. Generate JWT with org context\n  const token = await jwtService.generateToken({\n    userId: user.id,\n    email: user.email,\n    role: user.role,\n    organizationId: user.primaryOrg?.id,\n    organizationIds: orgs.map(o => o.organizationId),\n  });\n  \n  // 4. Return tokens (access + refresh)\n  res.json({\n    success: true,\n    data: {\n      user,\n      accessToken: token.accessToken,\n      refreshToken: token.refreshToken,\n    },\n  });\n};\n```\n\n### 3. Token Structure (JWT Claims)\n\n```json\n{\n  \"iss\": \"yuthub\",\n  \"sub\": \"user-id-123\",\n  \"email\": \"user@org.com\",\n  \"role\": \"admin\",\n  \"organizationId\": 456,\n  \"organizationIds\": [456, 789],\n  \"iat\": 1234567890,\n  \"exp\": 1234571490\n}\n```\n\n## Frontend Integration\n\n### 1. Authentication Hook\n\n```typescript\n// client/src/hooks/useAuth.ts\nconst { user, isAuthenticated, isLoading, logout } = useAuth();\n\n// user = {\n//   id: 'user-123',\n//   email: 'staff@org.com',\n//   role: 'admin',\n//   organizationId: 456,\n//   maxResidents: 100,\n//   subscriptionTier: 'professional'\n// }\n```\n\n### 2. Protected Routes\n\n```typescript\n// client/src/App.tsx\nimport { ProtectedRoute } from './components/ProtectedRoute';\n\n<Routes>\n  <Route path=\"/login\" element={<SignIn />} />\n  <Route\n    path=\"/app/dashboard\"\n    element={\n      <ProtectedRoute requiredRoles={['staff', 'manager', 'admin']}>\n        <Dashboard />\n      </ProtectedRoute>\n    }\n  />\n  <Route\n    path=\"/admin\"\n    element={\n      <ProtectedRoute requiredRoles={['admin']}>\n        <AdminPanel />\n      </ProtectedRoute>\n    }\n  />\n</Routes>\n```\n\n### 3. API Client with Organization Context\n\n```typescript\n// client/src/services/apiClient.ts\n// Automatically includes:\n// - Authorization: Bearer {accessToken}\n// - X-Organization-Id: {organizationId}\n// - Automatic token refresh on 401\n\nconst residents = await apiClient.get('/api/residents', {\n  organizationId: user.organizationId,\n});\n// Backend automatically filters by organization_id\n```\n\n## Backend Integration\n\n### 1. Multi-Auth Middleware\n\n```typescript\n// server/multiAuth.ts\n// Supports:\n// - Email/Password\n// - Google OAuth\n// - Microsoft OAuth\n// - LDAP\n// - SAML\n\nawait setupMultiAuth(app); // Initializes all providers\n```\n\n### 2. Enhanced Auth Middleware\n\n```typescript\n// server/middleware/enhancedAuthMiddleware.ts\nexport const extractToken = (req) => {\n  // 1. Extract from Authorization header\n  // 2. Verify JWT signature\n  // 3. Check token expiration\n  // 4. Attach to req.auth for downstream use\n};\n\nexport const setTenantContext = (req, res, next) => {\n  // 1. Extract organizationId from token or header\n  // 2. Validate user has access to org\n  // 3. Attach to req.tenantContext for data isolation\n};\n```\n\n### 3. RBAC Middleware\n\n```typescript\n// server/security/rbacMiddleware.ts\nexport const requirePermission = (permission) => {\n  return async (req, res, next) => {\n    // 1. Get user role from token\n    // 2. Check if role has permission\n    // 3. Verify organization context matches\n    // 4. Allow or deny request\n  };\n};\n```\n\n### 4. Data Isolation\n\n```typescript\n// All queries must include organization_id filter\n\n// CORRECT:\nconst residents = await db.query(residents)\n  .where(\n    and(\n      eq(residents.organizationId, tenantContext.organizationId),\n      eq(residents.status, 'active')\n    )\n  );\n\n// INCORRECT (SECURITY ISSUE):\nconst residents = await db.query(residents)\n  .where(eq(residents.status, 'active'));\n  // ^ Missing organizationId filter! Leaks data between tenants\n```\n\n## Subscription & Licensing\n\n### Feature Tier System\n\n```typescript\n// Subscription tiers define limits and features\nconst tiers = {\n  trial: {\n    maxResidents: 25,\n    maxProperties: 1,\n    features: { analytics: false, apiAccess: false },\n  },\n  starter: {\n    maxResidents: 50,\n    maxProperties: 5,\n    features: { analytics: true, apiAccess: false },\n  },\n  professional: {\n    maxResidents: 500,\n    maxProperties: 50,\n    features: { analytics: true, apiAccess: true },\n  },\n  enterprise: {\n    maxResidents: -1, // unlimited\n    maxProperties: -1,\n    features: { analytics: true, apiAccess: true, customBranding: true },\n  },\n};\n```\n\n### Usage Enforcement\n\n```typescript\n// Backend middleware checks limits on creation\napp.post('/api/residents', requireActiveSubscription, async (req, res) => {\n  // 1. Check current resident count\n  const count = await db.query(residents)\n    .where(eq(residents.organizationId, req.tenantContext.organizationId))\n    .then(r => r.length);\n  \n  // 2. Verify under limit\n  const org = await getOrganization(req.tenantContext.organizationId);\n  if (count >= org.maxResidents) {\n    return res.status(403).json({\n      error: 'Resident limit exceeded. Upgrade your plan.',\n    });\n  }\n  \n  // 3. Create resident\n  // ...\n});\n```\n\n## Testing Multi-Tenant Flow\n\n### 1. Local Development Setup\n\n```bash\n# Set environment variables\nexport DATABASE_URL=\"postgresql://user:pass@localhost:5432/yuthub\"\nexport JWT_SECRET=\"dev-secret-key\"\nexport SESSION_SECRET=\"dev-session-key\"\n\n# Run migrations\nnpm run db:push\n\n# Start backend\nnpm run dev:server\n\n# Start frontend (in another terminal)\nnpm run dev:client\n```\n\n### 2. Manual Test Scenarios\n\n#### Scenario 1: Multi-Organization Isolation\n```\n1. Create org1 with user1 (admin)\n2. Create org2 with user2 (admin)\n3. user1 logs in\n   - Should see only org1's data\n   - Should NOT see org2's residents/properties\n4. user2 logs in\n   - Should see only org2's data\n   - Should NOT see org1's data\n```\n\n#### Scenario 2: Cross-Organization Access Blocked\n```\n1. user1 from org1 logged in (has accessToken)\n2. user1 attempts: GET /api/residents?organizationId=org2\n   - Backend should verify tenantContext matches organizationId\n   - Request should be DENIED (403 Forbidden)\n```\n\n#### Scenario 3: Role-Based Access\n```\n1. org1 has:\n   - user1 (admin)\n   - user2 (staff)\n2. user1 can: read/write all data, manage users\n3. user2 can: read residents, update own assignments only\n4. user2 attempts: DELETE /api/properties/1\n   - Denied by RBAC middleware (403 Forbidden)\n```\n\n#### Scenario 4: Subscription Limits\n```\n1. org1 has Professional tier (max 100 residents)\n2. org1 has 100 residents\n3. Admin attempts: POST /api/residents\n   - Denied (403 Limit Exceeded)\n   - Prompt to upgrade to Enterprise\n```\n\n## API Endpoints\n\n### Authentication\n- `POST /auth/login` - Email/password login\n- `POST /auth/signup` - Create new organization\n- `POST /auth/refresh` - Refresh access token\n- `POST /auth/logout` - Invalidate session\n- `POST /auth/password-reset` - Reset password\n- `POST /auth/mfa/enable` - Enable two-factor auth\n\n### User Management\n- `GET /api/auth/user` - Get current user + organization context\n- `GET /api/users` - List organization users (admin only)\n- `POST /api/users/{userId}` - Invite user to organization\n- `DELETE /api/users/{userId}` - Remove user from organization\n\n### Organization\n- `GET /api/organizations` - Get current organization details\n- `PUT /api/organizations` - Update organization settings\n- `GET /api/organizations/subscription` - Get subscription details\n\n### Data Operations (All scoped by organizationId)\n- `GET /api/residents` - List residents\n- `POST /api/residents` - Create resident\n- `GET /api/properties` - List properties\n- `POST /api/properties` - Create property\n- etc.\n\n## Security Checklist\n\n- [ ] JWT tokens include organizationId claim\n- [ ] All data queries filter by organizationId\n- [ ] setTenantContext middleware validates user org access\n- [ ] RBAC middleware checks role permissions\n- [ ] Refresh tokens stored in httpOnly cookies\n- [ ] CORS configured to allow only frontend domain\n- [ ] API rate limiting enabled\n- [ ] Audit logging on sensitive operations\n- [ ] Password reset tokens expire after 1 hour\n- [ ] MFA backup codes stored encrypted\n- [ ] Database has org_id indexes on all tables\n\n## Deployment\n\n### Environment Variables Required\n\n```bash\n# Database\nDATABASE_URL=postgresql://...\n\n# JWT\nJWT_SECRET=...\nJWT_EXPIRY=1h\nREFRESH_TOKEN_EXPIRY=7d\n\n# Session\nSESSION_SECRET=...\n\n# OAuth Providers\nGOOGLE_CLIENT_ID=...\nGOOGLE_CLIENT_SECRET=...\nMICROSOFT_CLIENT_ID=...\nMICROSOFT_CLIENT_SECRET=...\n\n# LDAP/SAML\nLDAP_SERVER_URL=...\nSAML_ENTRY_POINT=...\n\n# Frontend\nREACT_APP_API_URL=https://api.yuthub.com\n```\n\n### Database Indexes (Performance)\n\n```sql\n-- Multi-tenant data isolation indexes\nCREATE INDEX idx_properties_org_id ON properties(organization_id);\nCREATE INDEX idx_residents_org_id ON residents(organization_id);\nCREATE INDEX idx_incidents_org_id ON incidents(organization_id);\n\n-- Composite indexes for common queries\nCREATE INDEX idx_residents_org_status ON residents(organization_id, status);\nCREATE INDEX idx_properties_org_type ON properties(organization_id, property_type);\n\n-- User-organization relationship\nCREATE INDEX idx_user_orgs_user_id ON user_organizations(user_id);\nCREATE INDEX idx_user_orgs_org_id ON user_organizations(organization_id);\nCREATE INDEX idx_user_orgs_user_org ON user_organizations(user_id, organization_id);\n```\n\n## Troubleshooting\n\n### Issue: \"Invalid organization context\"\n- Check JWT token includes organizationId claim\n- Verify X-Organization-Id header matches token claim\n- Ensure user has access to requested organization\n\n### Issue: \"Cross-tenant data leak\"\n- Check all queries include organizationId filter\n- Verify RBAC middleware is applied to all routes\n- Audit recent code changes for missing org_id conditions\n\n### Issue: \"Token refresh fails\"\n- Verify refresh token cookie is set (httpOnly)\n- Check refresh token hasn't expired\n- Ensure CORS includes credential: 'include'\n\n### Issue: \"User sees data from wrong organization\"\n- Frontend bug: Check localStorage for correct organizationId\n- Backend bug: Check setTenantContext middleware is applied\n- Database bug: Verify indexes on organizationId columns\n\n## References\n\n- Database Schema: `/Users/imac/Projects/YUTHUB/shared/schema.ts`\n- Auth Implementation: `/Users/imac/Projects/YUTHUB/server/multiAuth.ts`\n- Enhanced Middleware: `/Users/imac/Projects/YUTHUB/server/middleware/enhancedAuthMiddleware.ts`\n- RBAC: `/Users/imac/Projects/YUTHUB/server/security/rbacMiddleware.ts`\n- Frontend Auth: `/Users/imac/Projects/YUTHUB/client/src/hooks/useAuth.ts`\n- Protected Routes: `/Users/imac/Projects/YUTHUB/client/src/components/ProtectedRoute.tsx`\n- API Client: `/Users/imac/Projects/YUTHUB/client/src/services/apiClient.ts`\n