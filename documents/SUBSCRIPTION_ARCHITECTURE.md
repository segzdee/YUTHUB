# YUTHUB Subscription and Multi-Tenancy Architecture\n\n## Overview\n\nYUTHUB implements a comprehensive SaaS subscription model with three commercial tiers (Starter, Professional, Enterprise) plus a trial period. The system enforces multi-tenant data isolation at the database level, ensuring each organization's data is completely separate from others.\n\n## Core Concepts\n\n### 1. Organizations (Tenants)\n\nEach organization represents a separate customer in the SaaS platform:\n- Unique organization ID and name\n- Type: housing_provider, local_authority, charity, or private\n- Subscription details (tier, status, dates)\n- Resource limits (residents, properties)\n- Stripe integration (customer ID, subscription ID)\n- Feature flags for granular control\n\n### 2. Users and Organization Membership\n\nUsers are associated with organizations through the `user_organizations` junction table:\n- A user can belong to multiple organizations\n- Each membership has a role: admin, manager, staff, resident, support_worker\n- One organization is marked as primary for that user\n- Membership statuses: active, inactive, invited, pending\n\n### 3. Subscription Tiers\n\n#### Trial (Free)\n- Duration: 14 days (auto-converts to Starter)\n- Max Residents: 25\n- Max Properties: 1\n- Features: Basic reporting, progress tracking, email support, mobile app\n- Support: Email (business hours)\n\n#### Starter (£169/month annual, £199/month monthly)\n- Max Residents: 25\n- Max Properties: 1 (single location)\n- Features: Same as trial\n- Support: Email (business hours)\n- Use Case: Small charities, pilot projects\n\n#### Professional (£429/month annual, £499/month monthly)\n- Max Residents: 100\n- Max Properties: 5 (multi-location)\n- Features:\n  - Multi-property management\n  - Advanced analytics and dashboards\n  - Crisis intervention tools\n  - Gamified skill tracking\n  - Local authority integration\n  - White-label branding\n  - API access\n  - Dedicated customer success manager\n- Support: Priority (business hours)\n- Use Case: Medium-sized housing organizations\n\n#### Enterprise (£1,099/month annual, £1,299/month monthly)\n- Max Residents: Unlimited\n- Max Properties: Unlimited\n- Features:\n  - All Professional features\n  - AI-powered analytics and predictions\n  - Custom feature development\n  - On-premise deployment options\n  - Advanced integrations (finance, CRM, government)\n  - Single Sign-On (SAML/LDAP/OAuth)\n  - 24/7 priority support\n  - Training programs\n  - SLA guarantees\n- Support: 24/7 priority\n- Use Case: National providers, large institutions\n\n## Database Schema\n\n### Key Tables\n\n#### organizations\n```sql\n- id (PRIMARY KEY)\n- name, displayName\n- organizationType\n- subscriptionTier (trial, starter, professional, enterprise)\n- subscriptionStatus (trial, active, past_due, cancelled, paused)\n- billingCycle (monthly, annual)\n- subscriptionStartDate, subscriptionEndDate, trialEndDate\n- maxResidents, maxProperties (resource limits)\n- currentResidentCount, currentPropertyCount (usage tracking)\n- featuresEnabled (JSON - granular feature flags)\n- stripeCustomerId, stripeSubscriptionId\n- billingEmail, lastPaymentDate, nextBillingDate\n- mrr (Monthly Recurring Revenue)\n- usageAlertSent (for approaching limits)\n```\n\n#### user_organizations (junction table)\n```sql\n- id (PRIMARY KEY)\n- userId (FOREIGN KEY → users)\n- organizationId (FOREIGN KEY → organizations)\n- role (admin, manager, staff, resident, support_worker)\n- isPrimary (user's default organization)\n- status (active, inactive, invited, pending)\n- joinedDate, lastActivity\n- invitationToken, invitationExpiresAt (for pending invites)\n- invitedBy, invitedAt\n```\n\n#### subscription_plans (reference table)\n```sql\n- id (PRIMARY KEY)\n- name (Starter, Professional, Enterprise)\n- tier (UNIQUE: starter, professional, enterprise)\n- monthlyPrice, annualPrice\n- maxResidents, maxProperties\n- features (JSON - all feature flags)\n- supportLevel, supportHours\n- trialDays, trialAutoConvertTo\n- stripePriceIdMonthly, stripePriceIdAnnual\n```\n\n### Multi-Tenancy Enforcement\n\nAll domain tables include `organization_id` foreign key:\n- properties: organization_id\n- residents: organization_id\n- supportPlans: organization_id\n- incidents: organization_id\n- etc.\n\nDatabase queries must always filter by `organization_id` to ensure data isolation.\n\n## Authentication Flow\n\n1. **User Login**\n   - User authenticates via email/password, OAuth, OIDC, SAML, or LDAP\n   - Supabase Auth creates JWT token\n   - Token includes: userId, email, organizations\n\n2. **Load Subscription Info**\n   - `loadEnhancedSubscriptionInfo` middleware runs on every authenticated request\n   - Queries user's organizations and their subscription details\n   - Attaches to `req.subscription` and `req.tenant`\n   - Includes: organizationId, subscriptionTier, subscriptionStatus, features, limits\n\n3. **Multi-Tenancy Routing**\n   - `enforceMultiTenancy` middleware ensures user can only access their organizations\n   - Validates organizationId in request against user's membership\n   - Sets `req.organizationId` for query scoping\n\n## Access Control Implementation\n\n### Middleware Stack (in order)\n\n```typescript\n// 1. Authentication middleware (Supabase)\napp.use(requireAuth());\n\n// 2. Load subscription and organization info\napp.use(loadEnhancedSubscriptionInfo);\n\n// 3. Route-specific access control\napp.get('/api/analytics',\n  requireActiveSubscription,\n  requireModuleAccess('analytics'),\n  enforceMultiTenancy,\n  analyticsHandler\n);\n\napp.post('/api/residents',\n  requireActiveSubscription,\n  requireResidentCapacity,\n  enforceMultiTenancy,\n  createResidentHandler\n);\n```\n\n### Feature Access Control\n\n```typescript\n// Check for specific feature\napp.get('/api/crisis',\n  requireFeature('crisisConnect'),\n  crisisHandler\n);\n\n// Check for minimum tier\napp.get('/api/ai-insights',\n  requireMinimumTier('enterprise'),\n  aiInsightsHandler\n);\n\n// Check module access by tier\napp.get('/api/reports',\n  requireModuleAccess('reports'), // Blocked for trial/starter\n  reportsHandler\n);\n\n// Check user role within organization\napp.post('/api/organization/settings',\n  requireOrgRole('admin'),\n  updateOrgSettingsHandler\n);\n```\n\n## Stripe Integration\n\n### Webhook Events Handled\n\n1. **subscription.created**\n   - Organization's trial/paid subscription activated\n   - Update tier, limits, status to active\n\n2. **subscription.updated**\n   - Plan changed, billing cycle changed, etc.\n   - Update subscription details\n\n3. **subscription.deleted / canceled**\n   - Subscription cancelled by customer or failed\n   - Mark status as cancelled\n\n4. **invoice.paid**\n   - Payment received successfully\n   - Update lastPaymentDate, ensure status is active\n\n5. **invoice.payment_failed**\n   - Payment failed (card declined, insufficient funds, etc.)\n   - Mark status as past_due\n   - Trigger email notification to admin\n\n### Upgrade/Downgrade Flow\n\n**Upgrade:**\n1. User selects higher tier in UI\n2. Frontend creates Stripe checkout session\n3. User completes payment\n4. Stripe webhook calls upgrade handler\n5. Organization tier, limits, features updated\n6. UI refreshes with new capabilities\n7. Resources are immediately available\n\n**Downgrade:**\n1. User selects lower tier\n2. Stripe processes downgrade\n3. Webhook calls downgrade handler\n4. Organization tier, limits, features updated\n5. Premium features become read-only\n6. If over new limit (e.g., 50 residents → downgrade to 25 max), alert shown\n\n## Usage Limits and Alerts\n\n### Tracking\n- `currentResidentCount`: Auto-updated when residents added/removed\n- `currentPropertyCount`: Auto-updated when properties added/removed\n- Usage percentages calculated in middleware\n- Alert thresholds: 80% warning, 95% critical\n\n### Alert Flow\n1. Admin tries to add resident but at 100% capacity\n2. Middleware blocks with error: \"RESIDENT_LIMIT_REACHED\"\n3. Error response includes current count, max allowed, upgrade suggestion\n4. UI shows upgrade prompt\n5. Admin upgrades to higher tier\n6. Limits immediately increase\n\n## Feature Flags\n\n### Database vs. Code\n\n**Database approach** (recommended):\n```typescript\n// In database: featuresEnabled JSONB\n{\n  \"basicReporting\": true,\n  \"multiProperty\": false,\n  \"crisisConnect\": true\n}\n\n// In middleware\nif (!req.subscription.features['crisisConnect']) {\n  return res.status(403).json({ error: 'FEATURE_NOT_AVAILABLE' });\n}\n```\n\n**Constant approach** (fallback):\n```typescript\n// From subscriptionTiers.ts\nconst config = SUBSCRIPTION_TIERS[tier];\nif (!config.features.crisisConnect) {\n  // Feature not available\n}\n```\n\nBoth approaches work. Database flags allow real-time changes without code redeployment.\n\n## View-Only Mode for Cancelled Subscriptions\n\nWhen subscription status is \"cancelled\" or \"past_due\":\n- Write operations blocked (POST, PUT, DELETE)\n- Read operations allowed (GET)\n- Error responses include call-to-action to renew/update payment\n- Option: Graceful degradation over 14-day period before full lockout\n\n## API Endpoints (To Be Implemented)\n\n### Subscription Management\n```\nGET  /api/subscription/current      - Get current subscription details\nGET  /api/subscription/plans        - List available plans\nPOST /api/subscription/upgrade      - Upgrade to higher tier\nPOST /api/subscription/downgrade    - Downgrade to lower tier\nGET  /api/subscription/billing      - Get billing portal URL\nGET  /api/subscription/usage        - Get resource usage stats\n```\n\n### Organization Management\n```\nGET  /api/organization              - Get organization details\nPUT  /api/organization              - Update organization\nGET  /api/organization/members      - List organization members\nPOST /api/organization/members      - Invite member\nDEL  /api/organization/members/:id  - Remove member\n```\n\n### Usage and Billing\n```\nGET  /api/billing/history           - Invoice history\nGET  /api/billing/upcoming          - Next billing date and amount\nPOST /api/billing/payment-method    - Update payment method\n```\n\n## Stripe Configuration\n\n### Required Environment Variables\n```bash\nSTRIPE_SECRET_KEY=sk_live_...\nSTRIPE_WEBHOOK_SECRET=whsec_...\nSTRIPE_PUBLISHABLE_KEY=pk_live_...\n```\n\n### Products to Create in Stripe\n\n1. **YUTHUB Starter (Monthly)**\n   - Price ID: price_starter_monthly\n   - Amount: £199/month\n   - Billing: Monthly\n\n2. **YUTHUB Starter (Annual)**\n   - Price ID: price_starter_annual\n   - Amount: £169/month (billed £2,028/year)\n   - Billing: Annual\n\n3. **YUTHUB Professional (Monthly)**\n   - Price ID: price_professional_monthly\n   - Amount: £499/month\n   - Billing: Monthly\n\n4. **YUTHUB Professional (Annual)**\n   - Price ID: price_professional_annual\n   - Amount: £429/month (billed £5,148/year)\n   - Billing: Annual\n\n5. **YUTHUB Enterprise (Monthly)**\n   - Price ID: price_enterprise_monthly\n   - Amount: £1,299/month\n   - Billing: Monthly\n\n6. **YUTHUB Enterprise (Annual)**\n   - Price ID: price_enterprise_annual\n   - Amount: £1,099/month (billed £13,188/year)\n   - Billing: Annual\n\n## Testing\n\n### Local Development\n\n1. Use Stripe test mode keys\n2. Test cards:\n   - Success: 4242 4242 4242 4242\n   - Decline: 4000 0000 0000 0002\n\n3. Webhook testing:\n   ```bash\n   stripe listen --forward-to localhost:3000/api/billing/webhooks\n   ```\n\n### Test Scenarios\n\n1. **Trial to Starter**\n   - User signs up → trial organization created\n   - 14 days later, trial expires\n   - User upgrades to starter\n   - Verify status changes to active\n\n2. **Upgrade Professional**\n   - Starter user attempts to add 6th property\n   - Blocked with property limit error\n   - User upgrades to Professional\n   - Limit increases to 5 properties\n   - User can now add property\n\n3. **Payment Failure**\n   - Subscription payment fails\n   - Stripe webhook triggers invoice.payment_failed\n   - Organization status changes to past_due\n   - User blocked from write operations\n   - Email sent to admin\n\n## Monitoring and Alerts\n\n### Key Metrics\n- Active subscriptions by tier\n- Monthly Recurring Revenue (MRR)\n- Churn rate (cancelled subscriptions)\n- Upgrade/downgrade rates\n- Trial conversion rate\n- Payment failure rate\n\n### Alerting\n- Payment failures: immediate notification to admin\n- Approaching limits: proactive notification 5 days before action needed\n- Usage spikes: alert if resident/property count increases suddenly\n\n## Future Enhancements\n\n1. **Usage-based pricing**: Charge per resident/property beyond limits\n2. **Add-ons**: Extra properties, dedicated support, API calls\n3. **Discounts**: Volume discounts for multi-year contracts\n4. **Metered billing**: Real-time tracking with daily syncs to Stripe\n5. **Trial extensions**: Manual or automatic for key prospects\n6. **Free accounts**: Permanent free tier for specific use cases\n"